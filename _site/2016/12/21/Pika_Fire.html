<!DOCTYPE html>
<html lang="zh-CN">
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Pika CPU火焰图</title>
  <meta name="description" content="在压测pika的时候发现首先CPU会达到瓶颈，DDZ上午推荐火焰图，今天简单了解了一下，这里记录一下安装及使用过程">

  <link rel="canonical" href="https://kernelmaker.github.io/2016/12/21/Pika_Fire.html">

  <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
  <!-- <link rel="stylesheet" href="/assets/css/icard_resume.css"> -->
  <link rel="stylesheet" href="/assets/css/font-awesome.min.css">
  <link rel="stylesheet" href="/assets/css/blog.css" >
  <link rel="stylesheet" href="/assets/css/syntax.css">

  <link rel="icon" type="image/png" href="/assets/img/avatar.jpeg">

  <!-- Google fonts -->
  <link rel='stylesheet' href='//fonts.googleapis.com/css?family=Open+Sans:300' type='text/css'>
  <link rel='stylesheet' href='//fonts.googleapis.com/css?family=Source+Sans+Pro' type='text/css'>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="assets/js/html5shiv.min.js"></script>
  <script src="assets/js/respond.min.js"></script>
  <![endif]-->

</head>

    <body>
        <header class="bloghead">
    <dev class="authorheader">
        <a href="/">
            <img alt="My Avatar" src="/assets/img/avatar.jpeg"/>
        </a>
        <dev class="blogtitle">
            <h1><a href="/">KernelMaker</a></h1>
            <h5> 墨鱼丸是只猫 </h5>
        </dev>
    </dev>

    <nav class="menu" role="nav">
        <ul>
            <li><a href="/">Home</a></li>
            <li>|</li>
            <li><a href="/menu.html">Menu</a></li>
            <li>|</li>
            <li><a target="_blank" href="https://github.com/kernelmaker">Github</a></li>
            <li>|</li>
            <li><a target="_blank" href="/about.html"> About Me</a></li>
        </ul>
    </nav>
</header>


        <main class="blogmain">
            <header>
                <h1 class="article-title">Pika CPU火焰图</h1>
                <p class="article-time">
                    2016年12月21日 星期三,  发表于 <span>北京</span>
                </p>
                <p class="article-hint">
                    如果您对本文有任何的建议或者疑问, 可以下方留言或者在
                    <a href="https://github.com/kernelmaker/kernelmaker.github.io/issues" target="_blank">这里给我提 Issues</a>, 谢谢! :)
                </p>
            </header>
            <p>在压测pika的时候发现首先CPU会达到瓶颈，DDZ上午推荐火焰图，今天简单了解了一下，这里记录一下安装及使用过程</p>

<h2 id="systemtap-">Systemtap 安装</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>1. yum install yum-utils
2. yum install kernel-devel
3. debuginfo-install kernel
4. yum install systemtap
</code></pre>
</div>

<p>如果第3步提示失败，则需要自己手动安装，首先拿到机器的内核版本号，以自己为例：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt;&gt;&gt; uname -r
3.10.0-229.el7.x86_64
</code></pre>
</div>

<p>然后在<a href="http://debuginfo.centos.org">这里</a>找到对应centos及内核版本的包，如7/x86_64下的kernel-debuginfo-common-x86_64-3.10.0-229.el7.x86_64.rpm和kernel-debuginfo-3.10.0-229.el7.x86_64.rpm，然后用rpm -ivh 安装就行了，需要先安装common，安装好之后测试：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>stap -ve 'probe begin { log("hello world") exit() }'
</code></pre>
</div>

<h2 id="openresty-systemtap-toolkit"><strong>openresty-systemtap-toolkit</strong></h2>

<p>使用systemtap需要自己写脚本，上手稍慢一些，不过<a href="https://github.com/openresty/openresty-systemtap-toolkit">openresty-systemtap-toolkit</a> 已经为nginx提供了不少工具脚本，其中sample-bt和sample-bt-off-cpu是通用的可以直接拿来用，如果server的cpu占用率很高可以通过sample-bt来定位占用大户，如果server IO拖住cpu怎么也上不来，可以使用sample-bt-off-cpu来定位</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1. 运行pika，拿到PID，开始压测
2. 执行sample-bt -p PID -t 10 -u -a '-vv' &gt; a.bt
</code></pre>
</div>

<p>-t代表监测10s，-u表示监测用户态，-k表示监测内核态，结束后结果重定向到a.bt中，然后需要用工具来讲结果转换成火焰图</p>

<h2 id="flamegraph"><strong>FlameGraph</strong></h2>

<p><a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a> 是用来生成火焰图的工具，很简单</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1. stackcollapse-stap.pl a.bt &gt; a.cbt;
2. flamegraph.pl a.cbt &gt; a.svg
</code></pre>
</div>

<p>a.svg就是我们需要的火焰图了。如下</p>

<p><img src="/assets/img/2016-12-21/fire.png" width="500px" /></p>

<h2 id="section">总结</h2>

<p>简单记录下安装使用</p>

            <footer class="article-footer">
    <div class="authorimage">
        <img src="/assets/img/avatar.jpeg" alt="My Avatar" class="img-circle">
    </div>
    <section class="author">
        <h4><a href="/about.html">KernelMaker</a></h4>
        <a href="mailto:songzhao.asm@icloud.com">songzhao.asm@icloud.com</a>
    </section>
</footer>

            <div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//kernelmaker.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </main>

        <div class="footer-copyright">
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="col-md-12">
                Copyright &copy; 2016 KernelMaker - All rights reserved.
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="/assets/js/jquery.min.js"></script>
<script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-77075031-1', 'auto');
  ga('send', 'pageview');

</script>


    </body>

</html>
